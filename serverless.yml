service: melvin-alexa-intent-handlers

frameworkVersion: ">=1.4.0 <2.0.0"

provider:
  name: aws
  runtime: nodejs10.x
  stage: ${self:custom.stage}
  region: eu-west-1
  memorySize: 2048
  reservedConcurrency: 1
  tracing:
    lambda: true
    apiGateway: true
  environment: ${self:custom.config.environment}
  timeout: 150
  iamRoleStatements:
    - Effect: Allow
      Action:
        - ssm:GetParameter
      Resource: "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/${self:service}/{self:provider.stage}/*"

    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_USER_UTTERANCE}"

    - Effect: Allow
      Action:
        - dynamodb:DescribeTable
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE_USER_SESSION}"

    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
      Resource: arn:aws:sqs:${self:provider.region}:${self:provider.environment.SQS_IRS}

    - Effect: Allow
      Action:
        - ses:SendEmail
      Resource: "*"

    - Effect: Allow
      Action:
        - events:ListRules
        - events:putRule
        - events:listTagsForResource
        - events:TagResource
      Resource: "*"

    - Effect: Allow
      Action:
        - ec2:CreateNetworkInterface
        - ec2:DescribeNetworkInterfaces
        - ec2:DeleteNetworkInterface
      Resource: "*"

    - Effect: Allow
      Action:
        - sts:AssumeRole
      Resource: "arn:aws:iam::073302257160:role/*"

functions:
  alexa-skill:
    handler: src/alexa-skill.handler
    events:
      - alexaSkill:
          appId: ${self:custom.config.alexa.appId}
          enabled: true

  sqs_irs_subscriber:
    handler: src/sqs/irs_subscriber.handler
    events:
      - sqs: arn:aws:sqs:${self:provider.region}:${self:provider.environment.SQS_IRS}

  warmup_service:
    handler: src/warmup_service/warmup_service.handler
    events:
      - schedule:
          description: 'warmup service scheduled event rule'
          rate: rate(10 minutes)
          enabled: false
          input:
            stage: ${self:custom.stage}
          tags:
            label: "melvin-alexa-intent-handlers-${self:provider.stage}-warmup_service"

plugins:
  - serverless-plugin-aws-alerts
  - serverless-plugin-include-dependencies
  - serverless-prune-plugin
  - serverless-pseudo-parameters
  - serverless-plugin-tag-events

package:
  exclude:
    - .vscode/**
  excludeDevDependencies: false

custom:
  # Our stage is based on what is passed in when running serverless
  # commands. Or fallsback to what we have set in the provider section.
  stage: ${opt:stage, 'dev'}

  # Load our configuration file specific to the environment based on the stage parameter
  config: ${file(config/${self:custom.stage}.yml)}

  # This will delete all but the n-most recent versions of each function deployed.
  prune:
    automatic: true
    includeLayers: true
    number: 3
